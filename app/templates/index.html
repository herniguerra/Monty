<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monty ‚Äî Trading Assistant</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <span class="logo-icon">üé©</span>
                    <span>Monty</span>
                </div>
            </div>
            <nav class="sidebar-nav">
                <a class="nav-item active" data-page="dashboard">
                    <span>üìä</span> Dashboard
                </a>
                <a class="nav-item" data-page="chat">
                    <span>üí¨</span> Chat with Monty
                </a>
                <a class="nav-item" data-page="trades">
                    <span>üìã</span> Trade Queue
                </a>
                <a class="nav-item" data-page="positions">
                    <span>üíº</span> Positions
                </a>
                <a class="nav-item" data-page="strategies">
                    <span>‚öôÔ∏è</span> Strategies
                </a>
                <a class="nav-item" data-page="logs">
                    <span>üìú</span> Logs
                </a>
                <a class="nav-item" data-page="settings">
                    <span>üîß</span> Settings
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main">
            <header class="header">
                <h1 class="page-title" id="page-title">Dashboard</h1>
                <div class="header-actions">
                    <button class="btn" onclick="runScan()">üîç Run Scan</button>
                    <button class="btn btn-primary" onclick="refreshData()">‚Üª Refresh</button>
                </div>
            </header>

            <div class="content" id="content">
                <!-- Dashboard View -->
                <div id="dashboard-view">
                    <!-- Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Portfolio Value</div>
                            <div class="stat-value" id="portfolio-value">$10,000.00</div>
                            <div class="stat-change positive" id="portfolio-change">+0.00%</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total P&L</div>
                            <div class="stat-value positive" id="total-pnl">$0.00</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Open Positions</div>
                            <div class="stat-value" id="open-positions">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Pending Trades</div>
                            <div class="stat-value" id="pending-trades">0</div>
                        </div>
                    </div>

                    <!-- Two Column Layout -->
                    <div class="two-columns">
                        <!-- Trade Queue Preview -->
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Pending Approvals</span>
                                <button class="btn" onclick="showPage('trades')">View All</button>
                            </div>
                            <div class="trade-queue" id="trade-queue-preview">
                                <div class="empty-state">
                                    <div class="empty-state-icon">üò¥</div>
                                    <div class="empty-state-text">No pending trades. Monty is watching the market...
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Log -->
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Monty's Diary</span>
                            </div>
                            <div class="log-panel" id="log-panel">
                                <div class="log-entry info">
                                    <span class="timestamp">[--:--:--]</span> Waiting for first scan...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>



                <!-- Positions View (hidden by default) -->
                <div id="positions-view" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Open Positions</span>
                        </div>
                        <table class="positions-table">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Entry Price</th>
                                    <th>Quantity</th>
                                    <th>Value</th>
                                    <th>P&L</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="positions-table-body">
                                <tr>
                                    <td colspan="6" style="text-align: center; color: var(--text-muted);">
                                        No open positions
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Trades View (hidden by default) -->
                <div id="trades-view" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">‚è≥ Pending Trades</span>
                            <button class="btn btn-danger" onclick="rejectAllTrades()">Reject All</button>
                        </div>
                        <div id="pending-trades-list" class="trades-list">
                            <div class="trades-empty">No pending trades</div>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 24px;">
                        <div class="card-header">
                            <span class="card-title">üìú Trade History</span>
                        </div>
                        <div id="trade-history-list" class="trades-list">
                            <div class="trades-empty">No trade history</div>
                        </div>
                    </div>
                </div>

                <!-- Strategies View (hidden by default) -->
                <div id="strategies-view" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Strategy Modules</span>
                        </div>
                        <div class="strategy-list" id="strategy-list">
                            <div class="strategy-item">
                                <div class="strategy-info">
                                    <span class="strategy-name">üìâ RSI Dip Buyer</span>
                                    <span class="strategy-desc">Buys when RSI indicates oversold conditions</span>
                                </div>
                                <div class="toggle active" onclick="toggleStrategy(this, 'rsi_dip')"></div>
                            </div>
                            <div class="strategy-item">
                                <div class="strategy-info">
                                    <span class="strategy-name">üì∞ Sentiment Surfer</span>
                                    <span class="strategy-desc">Trades based on news sentiment shifts</span>
                                </div>
                                <div class="toggle active" onclick="toggleStrategy(this, 'sentiment_surge')"></div>
                            </div>
                            <div class="strategy-item">
                                <div class="strategy-info">
                                    <span class="strategy-name">üöÄ Moonshot Scanner</span>
                                    <span class="strategy-desc">Scans for breakout opportunities (HIGH RISK)</span>
                                </div>
                                <div class="toggle" onclick="toggleStrategy(this, 'moonshot_scanner')"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat View (hidden by default) -->
                <div id="chat-view" style="display: none;">
                    <div class="chat-container">
                        <div class="chat-messages" id="chat-messages">
                            <div class="chat-message assistant">
                                <div class="chat-avatar">üé©</div>
                                <div class="chat-bubble">
                                    Hey there! I'm Monty, your trading assistant. üëã
                                    <br><br>
                                    I can help you with:
                                    <ul>
                                        <li>Check current prices: <em>"What's the price of ETH?"</em></li>
                                        <li>View your portfolio: <em>"Show me my positions"</em></li>
                                        <li>Analyze sentiment: <em>"What's the market mood?"</em></li>
                                        <li>Propose trades: <em>"Should I buy some SOL?"</em></li>
                                    </ul>
                                    What would you like to know?
                                </div>
                            </div>
                        </div>
                        <div class="chat-input-container">
                            <input type="text" id="chat-input" class="chat-input" placeholder="Ask Monty anything..."
                                onkeypress="handleChatKeypress(event)">
                            <button class="btn" onclick="showContextDebug()" title="View Monty's Context">üîç
                                Context</button>
                            <button class="btn" onclick="exportChatAsMarkdown()" title="Export as Markdown">üì•
                                Export</button>
                            <button class="btn btn-primary" onclick="sendChatMessage()">Send</button>
                        </div>
                    </div>
                </div>

                <!-- Logs View (hidden by default) -->
                <div id="logs-view" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Full Activity Log</span>
                            <button class="btn" onclick="clearLogs()">Clear</button>
                        </div>
                        <div class="log-panel" id="log-panel-full" style="max-height: 600px;">
                            <div class="log-entry info">
                                <span class="timestamp">[--:--:--]</span> Log initialized
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings View (hidden by default) -->
                <div id="settings-view" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Application Settings</span>
                        </div>
                        <div class="settings-form">
                            <div class="form-group">
                                <label for="scan-interval">Scan Frequency</label>
                                <select id="scan-interval" class="form-select">
                                    <option value="1">Every 1 minute</option>
                                    <option value="5" selected>Every 5 minutes</option>
                                    <option value="15">Every 15 minutes</option>
                                    <option value="30">Every 30 minutes</option>
                                </select>
                                <span class="form-hint">How often Monty scans for trading opportunities</span>
                            </div>
                            <div class="form-group">
                                <label for="initial-balance">Initial Balance ($)</label>
                                <input type="number" id="initial-balance" class="form-input" value="10000" min="100"
                                    step="100">
                                <span class="form-hint">Starting capital for paper trading (used on reset)</span>
                            </div>
                            <div class="form-group">
                                <label for="trade-expiry">Trade Expiry</label>
                                <select id="trade-expiry" class="form-select">
                                    <option value="15">15 minutes</option>
                                    <option value="30" selected>30 minutes</option>
                                    <option value="60">1 hour</option>
                                    <option value="120">2 hours</option>
                                </select>
                                <span class="form-hint">How long pending trades wait for approval</span>
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-primary" onclick="saveSettings()">üíæ Save Settings</button>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 24px;">
                        <div class="card-header">
                            <span class="card-title">Danger Zone</span>
                        </div>
                        <div class="settings-form">
                            <p style="color: var(--text-secondary); margin-bottom: 16px;">
                                This will wipe all trades, positions, and reset your cash balance to the initial
                                balance.
                                This action cannot be undone.
                            </p>
                            <button class="btn btn-danger" onclick="showResetModal()">üóëÔ∏è Reset Portfolio</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Context Debug Modal -->
    <div id="context-modal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="closeContextModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîç Monty's Current Context</h3>
                <button class="btn" onclick="closeContextModal()">‚úï</button>
            </div>
            <div class="modal-body" id="context-modal-body">
                Loading...
            </div>
        </div>
    </div>

    <!-- Reset Confirmation Modal -->
    <div id="reset-modal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="closeResetModal()"></div>
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>‚ö†Ô∏è Reset Portfolio</h3>
                <button class="btn" onclick="closeResetModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 16px;">Are you sure you want to reset? This will:</p>
                <ul style="margin-bottom: 16px; padding-left: 20px;">
                    <li>Delete all trade proposals</li>
                    <li>Close all positions</li>
                    <li>Wipe trade history</li>
                    <li>Reset balance to initial capital</li>
                </ul>
                <p style="color: var(--danger); font-weight: 500;">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeResetModal()">Cancel</button>
                <button class="btn btn-danger" onclick="resetPortfolio()">üóëÔ∏è Yes, Reset</button>
            </div>
        </div>
    </div>

    <script>
        // Navigation
        function showPage(page) {
            // Hide all views
            document.querySelectorAll('[id$="-view"]').forEach(el => el.style.display = 'none');

            // Show selected view
            const viewId = page === 'dashboard' ? 'dashboard-view' : `${page}-view`;
            document.getElementById(viewId).style.display = 'block';

            // Update nav
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`[data-page="${page}"]`).classList.add('active');

            // Update title
            const titles = {
                'dashboard': 'Dashboard',
                'chat': 'Chat with Monty',
                'trades': 'Trade Queue',
                'positions': 'Positions',
                'strategies': 'Strategies',
                'logs': 'Activity Log',
                'settings': 'Settings'
            };
            document.getElementById('page-title').textContent = titles[page] || 'Dashboard';

            // Load page-specific data
            if (page === 'trades') {
                loadPendingTrades();
                loadTradeHistory();
            } else if (page === 'positions') {
                loadPositions();
            } else if (page === 'settings') {
                loadSettings();
            }
        }

        // Click handlers for nav
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => showPage(item.dataset.page));
        });

        // Strategy toggle
        function toggleStrategy(el, strategyId) {
            el.classList.toggle('active');
            const enabled = el.classList.contains('active');
            console.log(`Strategy ${strategyId}: ${enabled ? 'enabled' : 'disabled'}`);
            // TODO: API call to update strategy
        }

        // Refresh data
        async function refreshData() {
            // Show loading spinners immediately
            const statIds = ['portfolio-value', 'total-pnl', 'open-positions', 'pending-trades'];
            const changeId = 'portfolio-change';

            statIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.innerHTML = '<span class="spinner"></span>';
                    el.classList.add('loading');
                }
            });

            const changeEl = document.getElementById(changeId);
            if (changeEl) {
                changeEl.innerHTML = '<span class="spinner spinner-sm"></span>';
                changeEl.classList.add('loading');
            }

            try {
                // Fetch data and enforce minimum spinner display time (300ms)
                const minDisplayTime = new Promise(resolve => setTimeout(resolve, 300));
                const [response] = await Promise.all([fetch('/api/portfolio'), minDisplayTime]);
                const data = await response.json();

                // Defensive defaults
                const totalValue = data.total_value ?? 10000;
                const pnl = data.pnl ?? 0;
                const pnlPct = data.pnl_pct ?? 0;
                const positions = data.positions ?? {};

                // Update stats (remove loading state)
                const portfolioEl = document.getElementById('portfolio-value');
                portfolioEl.textContent = `$${totalValue.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;
                portfolioEl.classList.remove('loading');

                const pnlEl = document.getElementById('total-pnl');
                pnlEl.textContent = `$${pnl.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;
                pnlEl.className = `stat-value ${pnl >= 0 ? 'positive' : 'negative'}`;

                const changeElUpdate = document.getElementById('portfolio-change');
                changeElUpdate.textContent = `${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(2)}%`;
                changeElUpdate.className = `stat-change ${pnlPct >= 0 ? 'positive' : 'negative'}`;

                const positionsEl = document.getElementById('open-positions');
                positionsEl.textContent = Object.keys(positions).length;
                positionsEl.classList.remove('loading');

                const pendingEl = document.getElementById('pending-trades');
                pendingEl.classList.remove('loading');
                // Pending trades count will be updated by loadPendingTradesCount

                addLog('Data refreshed', 'success');

                // Also fetch pending trades count
                loadPendingTradesCount();
            } catch (e) {
                // Remove loading state on error
                statIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.textContent = '‚Äî';
                        el.classList.remove('loading');
                    }
                });
                if (changeEl) {
                    changeEl.textContent = '‚Äî';
                    changeEl.classList.remove('loading');
                }
                addLog(`Refresh failed: ${e.message}`, 'error');
            }
        }

        // Load pending trades count for dashboard stat
        async function loadPendingTradesCount() {
            try {
                const response = await fetch('/api/trades/pending');
                const data = await response.json();
                const count = data.trades?.length ?? 0;
                document.getElementById('pending-trades').textContent = count;
            } catch (e) {
                document.getElementById('pending-trades').textContent = '0';
            }
        }

        // Load positions into the Positions page table
        async function loadPositions() {
            try {
                const response = await fetch('/api/portfolio');
                const data = await response.json();
                const positions = data.positions || {};
                const tbody = document.getElementById('positions-table-body');

                if (Object.keys(positions).length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; color: var(--text-muted);">
                                No open positions
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = Object.entries(positions).map(([symbol, pos]) => {
                    const pnlClass = (pos.pnl || 0) >= 0 ? 'positive' : 'negative';
                    const pnlSign = (pos.pnl || 0) >= 0 ? '+' : '';
                    return `
                        <tr>
                            <td><strong>${symbol}</strong></td>
                            <td>$${pos.entry_price?.toFixed(2) || 'N/A'}</td>
                            <td>${pos.quantity?.toFixed(6) || 'N/A'}</td>
                            <td>$${pos.value?.toFixed(2) || 'N/A'}</td>
                            <td class="${pnlClass}">
                                ${pnlSign}$${(pos.pnl || 0).toFixed(2)} (${pnlSign}${(pos.pnl_pct || 0).toFixed(2)}%)
                            </td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="proposeSell('${symbol}')">Sell</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (e) {
                console.error('Failed to load positions:', e);
            }
        }

        // Helper to propose a sell via chat
        function proposeSell(symbol) {
            // Navigate to chat and auto-fill sell message
            showPage('chat');
            const input = document.getElementById('chat-input');
            if (input) {
                input.value = `sell my ${symbol.split('/')[0]} position`;
                input.focus();
            }
        }

        // Run scan
        async function runScan() {
            addLog('Manual scan triggered...', 'info');
            try {
                const response = await fetch('/api/scan', { method: 'POST' });
                const data = await response.json();
                addLog(`Scan complete: ${data.proposals_count} proposals`, 'success');
                refreshData();
            } catch (e) {
                addLog(`Scan failed: ${e.message}`, 'error');
            }
        }

        // Logging
        function addLog(message, type = 'info') {
            const now = new Date();
            const timestamp = now.toTimeString().split(' ')[0];
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;

            const logPanel = document.getElementById('log-panel');
            logPanel.appendChild(logEntry);
            logPanel.scrollTop = logPanel.scrollHeight;

            // Also add to full log
            const fullLog = document.getElementById('log-panel-full');
            if (fullLog) {
                fullLog.appendChild(logEntry.cloneNode(true));
                fullLog.scrollTop = fullLog.scrollHeight;
            }
        }

        function clearLogs() {
            document.getElementById('log-panel-full').innerHTML = '';
            addLog('Logs cleared', 'info');
        }

        // Initial load
        addLog('üé© Monty dashboard loaded', 'success');
        refreshData();

        // Auto-refresh every 30 seconds
        setInterval(refreshData, 30000);

        // ===== CHAT FUNCTIONS =====
        let chatLoading = false;

        function handleChatKeypress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();

            if (!message) return;

            // Prevent double-send while loading
            if (chatLoading) {
                console.log('[Chat] Blocked: already loading');
                return;
            }

            // Add user message to chat FIRST
            console.log('[Chat] Adding user message:', message);
            addChatMessage('user', message);
            input.value = '';

            // Create streaming assistant bubble
            chatLoading = true;
            const streamingBubble = createStreamingBubble();
            let fullText = '';
            let tradeProposal = null;

            try {
                const response = await fetch('/api/chat/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });

                    // Parse SSE events from buffer
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || ''; // Keep incomplete line in buffer

                    for (const line of lines) {
                        if (!line.startsWith('data: ')) continue;

                        try {
                            const event = JSON.parse(line.slice(6));

                            if (event.type === 'text') {
                                fullText += event.delta;
                                updateStreamingBubble(streamingBubble, fullText);
                            } else if (event.type === 'tool_call') {
                                addThinkingStep(streamingBubble, 'tool_call', event);
                            } else if (event.type === 'tool_result') {
                                addThinkingStep(streamingBubble, 'tool_result', event);
                            } else if (event.type === 'done') {
                                // Capture trade proposal from done event
                                if (event.trade_proposal) {
                                    tradeProposal = event.trade_proposal;
                                }
                                finalizeStreamingBubble(streamingBubble, fullText);
                            } else if (event.type === 'error') {
                                fullText += `\n\nError: ${event.message}`;
                                finalizeStreamingBubble(streamingBubble, fullText);
                            }
                        } catch (parseErr) {
                            console.warn('[Chat] Failed to parse SSE event:', line);
                        }
                    }
                }

                // Final cleanup if no done event received
                finalizeStreamingBubble(streamingBubble, fullText || 'No response received.');

                // Add trade approval buttons if applicable
                if (tradeProposal && tradeProposal.trade_id) {
                    addTradeApprovalButtons(tradeProposal.trade_id);
                }

            } catch (e) {
                console.error('[Chat] Stream error:', e);
                finalizeStreamingBubble(streamingBubble, `Sorry, something went wrong: ${e.message}`);
            }

            chatLoading = false;
        }

        function createStreamingBubble() {
            const messagesContainer = document.getElementById('chat-messages');
            const msgId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

            const msgDiv = document.createElement('div');
            msgDiv.className = 'chat-message assistant';
            msgDiv.id = msgId;

            msgDiv.innerHTML = `
                <div class="chat-avatar">üé©</div>
                <div class="chat-content-wrapper">
                    <div class="thinking-section loading" id="thinking-${msgId}">
                        <button class="thinking-toggle" onclick="toggleThinking('${msgId}')">
                            <span class="thinking-toggle-icon">‚ñ∂</span>
                            <span>Thinking...</span>
                        </button>
                        <div class="thinking-content"></div>
                    </div>
                    <div class="chat-bubble streaming"><span class="stream-cursor">‚ñå</span></div>
                </div>
            `;

            messagesContainer.appendChild(msgDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            return msgDiv;
        }

        function toggleThinking(msgId) {
            const section = document.getElementById(`thinking-${msgId}`);
            if (section) {
                section.classList.toggle('expanded');
            }
        }

        function addThinkingStep(bubble, type, data) {
            const thinkingContent = bubble.querySelector('.thinking-content');
            if (!thinkingContent) return;

            const step = document.createElement('div');
            step.className = 'thinking-step';

            if (type === 'tool_call') {
                step.innerHTML = `
                    <span class="thinking-step-icon">üîß</span>
                    <div>
                        <span class="thinking-step-tool">${data.tool}</span>
                        <span style="color: var(--text-muted); font-size: 11px;">(${Object.keys(data.args || {}).join(', ') || 'no args'})</span>
                    </div>
                `;
            } else if (type === 'tool_result') {
                // Find the last step and add result to it
                const lastStep = thinkingContent.querySelector('.thinking-step:last-child');
                if (lastStep) {
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'thinking-step-result';
                    const preview = typeof data.result === 'string'
                        ? data.result.slice(0, 200)
                        : JSON.stringify(data.result, null, 2).slice(0, 200);
                    resultDiv.textContent = preview + (preview.length >= 200 ? '...' : '');
                    lastStep.appendChild(resultDiv);
                    return;
                }
            }

            thinkingContent.appendChild(step);

            // Update toggle text with count
            const toggle = bubble.querySelector('.thinking-toggle span:last-child');
            const stepCount = thinkingContent.querySelectorAll('.thinking-step').length;
            if (toggle) {
                toggle.textContent = `Thinking... (${stepCount} tool${stepCount > 1 ? 's' : ''})`;
            }
        }

        function finalizeThinkingSection(bubble) {
            const thinkingSection = bubble.querySelector('.thinking-section');
            if (!thinkingSection) return;

            thinkingSection.classList.remove('loading');

            const stepCount = thinkingSection.querySelectorAll('.thinking-step').length;
            const toggle = thinkingSection.querySelector('.thinking-toggle span:last-child');

            if (stepCount === 0) {
                // No tools called, hide the thinking section
                thinkingSection.style.display = 'none';
            } else if (toggle) {
                toggle.textContent = `${stepCount} tool${stepCount > 1 ? 's' : ''} used`;
            }
        }

        function updateStreamingBubble(bubble, text) {
            const contentBubble = bubble.querySelector('.chat-bubble');
            if (!contentBubble) return;
            let formattedContent = formatChatContent(text);
            contentBubble.innerHTML = formattedContent + '<span class="stream-cursor">‚ñå</span>';

            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function finalizeStreamingBubble(bubble, text) {
            const contentBubble = bubble.querySelector('.chat-bubble');
            if (!contentBubble) return;
            contentBubble.classList.remove('streaming');
            contentBubble.innerHTML = formatChatContent(text);

            // Also finalize thinking section
            finalizeThinkingSection(bubble);
        }

        function formatChatContent(content) {
            return content
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/`(.+?)`/g, '<code>$1</code>');
        }

        function addToolCallsMessage(toolsHtml) {
            const messagesContainer = document.getElementById('chat-messages');
            const toolDiv = document.createElement('div');
            toolDiv.className = 'chat-tool-calls';
            toolDiv.innerHTML = toolsHtml;
            messagesContainer.appendChild(toolDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addChatMessage(role, content, isLoading = false) {
            const messagesContainer = document.getElementById('chat-messages');
            // Use timestamp + random to prevent ID collision
            const msgId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-message ${role}`;
            msgDiv.id = msgId;

            // Set data attribute for loading messages so we can clean them up
            if (isLoading) {
                msgDiv.setAttribute('data-loading', 'true');
            }

            const avatar = role === 'user' ? 'üë§' : 'üé©';

            // Convert markdown-like formatting
            let formattedContent = content
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/`(.+?)`/g, '<code>$1</code>');

            msgDiv.innerHTML = `
                <div class="chat-avatar">${avatar}</div>
                <div class="chat-bubble ${isLoading ? 'loading' : ''}">${formattedContent}</div>
            `;

            messagesContainer.appendChild(msgDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            return msgId;
        }

        function addTradeApprovalButtons(tradeId) {
            const messagesContainer = document.getElementById('chat-messages');

            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'trade-inline-actions';
            buttonsDiv.id = `inline-trade-${tradeId}`;
            buttonsDiv.innerHTML = `
                <button class="btn btn-success btn-sm" onclick="approveTradeInline(${tradeId})">‚úì Approve Trade</button>
                <button class="btn btn-danger btn-sm" onclick="rejectTradeInline(${tradeId})">‚úï Reject</button>
            `;

            messagesContainer.appendChild(buttonsDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function exportChatAsMarkdown() {
            const messages = document.querySelectorAll('#chat-messages .chat-message');
            const now = new Date();

            let markdown = `# Monty Chat Export\n`;
            markdown += `*Exported on ${now.toLocaleString()}*\n\n---\n\n`;

            messages.forEach(msg => {
                const isUser = msg.classList.contains('user');
                const bubble = msg.querySelector('.chat-bubble');
                if (!bubble) return;

                // Convert HTML back to plain text (roughly)
                let content = bubble.innerHTML
                    .replace(/<br\s*\/?>/gi, '\n')
                    .replace(/<strong>(.+?)<\/strong>/gi, '**$1**')
                    .replace(/<em>(.+?)<\/em>/gi, '*$1*')
                    .replace(/<code>(.+?)<\/code>/gi, '`$1`')
                    .replace(/<ul>/gi, '\n')
                    .replace(/<\/ul>/gi, '\n')
                    .replace(/<li>/gi, '- ')
                    .replace(/<\/li>/gi, '\n')
                    .replace(/<[^>]+>/g, '');  // Remove remaining HTML tags

                content = content.trim();

                if (isUser) {
                    markdown += `## üë§ You\n${content}\n\n`;
                } else {
                    markdown += `## üé© Monty\n${content}\n\n`;
                }
            });

            // Save to server
            try {
                const response = await fetch('/api/chat/export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ markdown })
                });
                const data = await response.json();

                if (data.status === 'exported') {
                    addLog(`Chat exported: ${data.filename}`, 'success');
                } else {
                    addLog(`Export failed: ${data.error}`, 'error');
                }
            } catch (e) {
                addLog(`Export failed: ${e.message}`, 'error');
            }
        }

        // Context Debug Modal
        async function showContextDebug() {
            const modal = document.getElementById('context-modal');
            const body = document.getElementById('context-modal-body');
            modal.style.display = 'flex';
            body.innerHTML = '<p style="color: var(--text-muted);">Loading context...</p>';

            try {
                const response = await fetch('/api/chat/context');
                const data = await response.json();

                if (data.error) {
                    body.innerHTML = `<p style="color: var(--danger);">Error: ${data.error}</p>`;
                    return;
                }

                // Format the context display
                let html = '';

                // Active Strategies
                html += '<h4>üìä Active Strategies</h4><ul>';
                if (data.active_strategies && data.active_strategies.length) {
                    data.active_strategies.forEach(s => {
                        html += `<li><strong>${s.name}</strong> - ${s.description} <span class="badge">${s.risk_level}</span></li>`;
                    });
                } else {
                    html += '<li>None loaded</li>';
                }
                html += '</ul>';

                // Portfolio
                html += '<h4>üí∞ Portfolio</h4>';
                if (data.portfolio) {
                    const positions = data.portfolio.positions || {};
                    const positionCount = Object.keys(positions).length;
                    html += `<ul>
                        <li>Cash: $${(data.portfolio.cash || 0).toLocaleString()}</li>
                        <li>Total Value: $${(data.portfolio.total_value || 0).toLocaleString()}</li>
                        <li>P&L: $${(data.portfolio.pnl || 0).toFixed(2)} (${(data.portfolio.pnl_pct || 0).toFixed(2)}%)</li>
                    </ul>`;

                    if (positionCount > 0) {
                        html += '<h4>üìä Open Positions</h4><ul>';
                        for (const [symbol, pos] of Object.entries(positions)) {
                            html += `<li><strong>${symbol}</strong>: ${pos.quantity?.toFixed(6) || 'N/A'} @ $${pos.entry_price?.toFixed(2) || 'N/A'}</li>`;
                        }
                        html += '</ul>';
                    } else {
                        html += '<p style="color: var(--text-muted);">No open positions</p>';
                    }
                }

                // Pending Trades
                html += '<h4>‚è≥ Pending Trades</h4>';
                if (data.pending_trades && data.pending_trades.length) {
                    html += '<ul>';
                    data.pending_trades.forEach(t => {
                        html += `<li>#${t.id}: ${t.action} ${t.symbol}</li>`;
                    });
                    html += '</ul>';
                } else {
                    html += '<p style="color: var(--text-muted);">No pending trades</p>';
                }

                // Recent Trades
                html += '<h4>üìú Recent Trades</h4>';
                if (data.recent_trades && data.recent_trades.length) {
                    html += '<ul>';
                    data.recent_trades.forEach(t => {
                        html += `<li>#${t.id}: ${t.action} ${t.symbol} - ${t.status}</li>`;
                    });
                    html += '</ul>';
                } else {
                    html += '<p style="color: var(--text-muted);">No trade history</p>';
                }

                // Dynamic Context
                html += '<h4>üß† Dynamic Context (injected per message)</h4>';
                html += `<pre style="background: var(--bg-elevated); padding: 12px; border-radius: 6px; font-size: 12px; overflow-x: auto;">${data.dynamic_context || 'N/A'}</pre>`;

                // System Prompt (collapsible)
                html += '<h4>üìù System Prompt</h4>';
                html += `<details><summary style="cursor: pointer; color: var(--accent);">Click to expand</summary>`;
                html += `<pre style="background: var(--bg-elevated); padding: 12px; border-radius: 6px; font-size: 11px; max-height: 300px; overflow: auto; white-space: pre-wrap;">${data.system_prompt || 'N/A'}</pre></details>`;

                html += `<p style="margin-top: 16px; color: var(--text-muted); font-size: 12px;">Chat history length: ${data.chat_history_length || 0} messages</p>`;

                body.innerHTML = html;
            } catch (e) {
                body.innerHTML = `<p style="color: var(--danger);">Failed to load context: ${e.message}</p>`;
            }
        }

        function closeContextModal() {
            document.getElementById('context-modal').style.display = 'none';
        }

        // ===== TRADE MANAGEMENT FUNCTIONS =====

        async function loadPendingTrades() {
            try {
                const response = await fetch('/api/trades/pending');
                const data = await response.json();
                const container = document.getElementById('pending-trades-list');

                if (!data.trades || data.trades.length === 0) {
                    container.innerHTML = '<div class="trades-empty">No pending trades</div>';
                    return;
                }

                container.innerHTML = data.trades.map(trade => `
                    <div class="trade-card pending" id="trade-${trade.id}">
                        <div class="trade-header">
                            <span class="trade-action ${trade.action.toLowerCase()}">${trade.action}</span>
                            <span class="trade-symbol">${trade.symbol}</span>
                            <span class="trade-time">${trade.time_remaining_mins} min left</span>
                        </div>
                        <div class="trade-body">
                            <div class="trade-price">$${trade.price?.toFixed(2) || 'N/A'}</div>
                            <div class="trade-strategy">${trade.strategy || 'Manual'}</div>
                            <div class="trade-reason">${trade.reasoning || ''}</div>
                        </div>
                        <div class="trade-actions">
                            <button class="btn btn-success" onclick="approveTrade(${trade.id})">‚úì Approve</button>
                            <button class="btn btn-danger" onclick="rejectTrade(${trade.id})">‚úï Reject</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Failed to load pending trades:', e);
            }
        }

        async function loadTradeHistory() {
            try {
                const response = await fetch('/api/chat/context');
                const data = await response.json();
                const container = document.getElementById('trade-history-list');

                if (!data.recent_trades || data.recent_trades.length === 0) {
                    container.innerHTML = '<div class="trades-empty">No trade history</div>';
                    return;
                }

                container.innerHTML = data.recent_trades.map(trade => `
                    <div class="trade-card ${trade.status.toLowerCase()}">
                        <div class="trade-header">
                            <span class="trade-action ${trade.action.toLowerCase()}">${trade.action}</span>
                            <span class="trade-symbol">${trade.symbol}</span>
                            <span class="trade-status ${trade.status.toLowerCase()}">${trade.status}</span>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Failed to load trade history:', e);
            }
        }

        async function approveTrade(tradeId, injectMessage = false) {
            try {
                const response = await fetch(`/api/trades/${tradeId}/approve`, { method: 'POST' });
                const data = await response.json();

                if (data.status === 'approved') {
                    // Inject user message to chat history if requested
                    if (injectMessage) {
                        await injectUserActionToChat(`I approve trade #${tradeId}`);
                    }

                    // Update UI
                    const tradeCard = document.getElementById(`trade-${tradeId}`);
                    if (tradeCard) {
                        tradeCard.classList.remove('pending');
                        tradeCard.classList.add('approved');
                        tradeCard.querySelector('.trade-actions').innerHTML = '<span class="trade-status approved">‚úì Approved</span>';
                    }
                    addLog(`Trade #${tradeId} approved`, 'success');
                    // Refresh lists
                    setTimeout(loadPendingTrades, 500);
                    setTimeout(loadTradeHistory, 500);
                }
            } catch (e) {
                addLog(`Failed to approve trade: ${e.message}`, 'error');
            }
        }

        async function rejectTrade(tradeId, injectMessage = false) {
            try {
                const response = await fetch(`/api/trades/${tradeId}/reject`, { method: 'POST' });
                const data = await response.json();

                if (data.status === 'rejected') {
                    // Inject user message to chat history if requested
                    if (injectMessage) {
                        await injectUserActionToChat(`I reject trade #${tradeId}`);
                    }

                    const tradeCard = document.getElementById(`trade-${tradeId}`);
                    if (tradeCard) {
                        tradeCard.remove();
                    }
                    addLog(`Trade #${tradeId} rejected`, 'info');
                    setTimeout(loadPendingTrades, 500);
                }
            } catch (e) {
                addLog(`Failed to reject trade: ${e.message}`, 'error');
            }
        }

        async function rejectAllTrades() {
            if (!confirm('Reject all pending trades?')) return;

            try {
                const response = await fetch('/api/trades/reject-all', { method: 'POST' });
                const data = await response.json();
                addLog(data.message, 'info');
                loadPendingTrades();
            } catch (e) {
                addLog(`Failed to reject all trades: ${e.message}`, 'error');
            }
        }

        // Load trades when Trade Queue page is shown
        const originalShowPage = document.querySelectorAll('.nav-item').forEach.bind(document.querySelectorAll('.nav-item'));
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                if (item.dataset.page === 'trades') {
                    setTimeout(() => {
                        loadPendingTrades();
                        loadTradeHistory();
                    }, 100);
                }
                if (item.dataset.page === 'positions') {
                    setTimeout(loadPositions, 100);
                }
            });
        });

        // Function to add inline trade approval buttons to chat
        function addTradeProposalToChat(tradeId, symbol, action, price) {
            const msgId = addChatMessage('assistant', `
                <div class="trade-proposal-inline">
                    <strong>Trade Proposal Created</strong><br>
                    <span class="trade-action ${action.toLowerCase()}">${action}</span> ${symbol} at $${price.toFixed(2)}<br>
                    <div class="trade-inline-actions" id="inline-trade-${tradeId}">
                        <button class="btn btn-success btn-sm" onclick="approveTradeInline(${tradeId})">‚úì Approve</button>
                        <button class="btn btn-danger btn-sm" onclick="rejectTradeInline(${tradeId})">‚úï Reject</button>
                    </div>
                </div>
            `);
            return msgId;
        }

        async function approveTradeInline(tradeId) {
            const container = document.getElementById(`inline-trade-${tradeId}`);
            if (container) container.innerHTML = '<span style="color: var(--success);">‚è≥ Executing...</span>';

            // Add user message to chat
            addChatMessage('user', `I approve trade #${tradeId}`);

            await approveTrade(tradeId, true);

            if (container) container.innerHTML = '<span style="color: var(--success);">‚úì Approved & Executed</span>';
        }

        async function rejectTradeInline(tradeId) {
            const container = document.getElementById(`inline-trade-${tradeId}`);
            if (container) container.innerHTML = '<span style="color: var(--text-muted);">‚úï Rejected</span>';

            // Add user message to chat
            addChatMessage('user', `I reject trade #${tradeId}`);

            await rejectTrade(tradeId, true);
        }

        // Inject user action as a message in chat history (server-side)
        async function injectUserActionToChat(message) {
            try {
                await fetch('/api/chat/inject', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, role: 'user' })
                });
            } catch (e) {
                console.log('[Chat] Failed to inject message:', e);
            }
        }

        // ===== SETTINGS FUNCTIONS =====

        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                const data = await response.json();

                document.getElementById('scan-interval').value = data.scan_interval_minutes;
                document.getElementById('initial-balance').value = data.initial_balance;
                document.getElementById('trade-expiry').value = data.trade_expiry_minutes;
            } catch (e) {
                console.error('Failed to load settings:', e);
            }
        }

        async function saveSettings() {
            try {
                const settings = {
                    scan_interval_minutes: parseInt(document.getElementById('scan-interval').value),
                    initial_balance: parseFloat(document.getElementById('initial-balance').value),
                    trade_expiry_minutes: parseInt(document.getElementById('trade-expiry').value)
                };

                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                const data = await response.json();

                if (data.status === 'updated') {
                    addLog(`Settings saved: scan every ${data.scan_interval_minutes} min`, 'success');
                    alert('Settings saved successfully!');
                } else {
                    addLog('Failed to save settings', 'error');
                }
            } catch (e) {
                console.error('Failed to save settings:', e);
                addLog(`Settings error: ${e.message}`, 'error');
            }
        }

        function showResetModal() {
            document.getElementById('reset-modal').style.display = 'flex';
        }

        function closeResetModal() {
            document.getElementById('reset-modal').style.display = 'none';
        }

        async function resetPortfolio() {
            closeResetModal();
            try {
                const response = await fetch('/api/reset', { method: 'POST' });
                const data = await response.json();

                if (data.status === 'reset') {
                    addLog(`Portfolio reset to $${data.initial_balance.toLocaleString()}`, 'success');
                    alert('Portfolio has been reset!');
                    refreshData();  // Refresh dashboard stats
                } else {
                    addLog('Reset failed: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (e) {
                console.error('Failed to reset portfolio:', e);
                addLog(`Reset error: ${e.message}`, 'error');
            }
        }
    </script>
</body>

</html>